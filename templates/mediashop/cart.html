{% extends 'shopping/optimum/base.html' %}
{% load i18n static user_agents humanize media_from_provider currency cache %}

{% block meta %}
    {{ block.super }}
    <meta name="abstract" content="{{ product.title }} - {{ service.project_name }}"/>
    <meta name="description" content="{{ product.artist }}"/>
    <meta property="og:title" content="{{ product.title }} - {{ service.project_name }}"/>
    <meta property="og:description" content="{{ product.artist }}"/>
    <meta property="og:image" content="{{ product.artist.photo }}"/>
    <meta property="og:site_name" content="{{ service.domain|upper }}" />
{% endblock %}

{% block page_title %}
    <title>{{ product.title }} - {{ service.project_name }}</title>
{% endblock %}
{% block head_style %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'ikwen/swiper/css/swiper.min.css' %}" type="text/css" media="screen" />
    <link rel="stylesheet" href="{% static 'afrobit/css/music-item-detail.css' %}?v=20.08.11" type="text/css" media="screen" />
    <style>
        .cart-content {clear: both; float: left; margin-top: 15px; width: 100%}
        .nav-xs {display: none !important;}
        @media (max-width: 767px) {
            .artist .songs li {height: 185px}
        }
        @media (min-width: 768px) {
            .artist .songs .actions .cost {margin-top: 30px}
            .artist .songs .cover-image {float: left}
        }
    </style>
{% endblock %}

{% block content %}
    <div id="top-notice-ctnr" style="display: none">
        <span class="floating-notice has-shade" style="float: none; position: static"> Error goes here </span>
    </div>
{#    {% cache 300 music_item_detail_content product.artist.slug product.slug %}#}
    <div class="content">
        <div class="container" style="padding-top: 65px">
            <div class="artist">
                <h3 class="name text-center" style="margin: 0 0 20px">{% trans "My Shopping Bag" %}</h3>
                <div class="col-xs-12 hidden-xs">
                    <button class="btn btn-deep-blue btn-lg payment-start pull-right" style="min-width: 240px">
                        {% trans "Checkout" %}
                    </button>
                    <div class="clearfix"></div>
                </div>
                <div class="songs cart-content">
                    <ul>
                        <li class="has-shade cart-item simpleCart_shelfItem tpl">
                            <div class="close">&times;</div>
                            <div class="cover-image"></div>
                            <span class="hidden item_id"></span>
                            <span class="hidden item_url"></span>
                            <span class="hidden item_image"></span>
                            <span class="hidden item_quantity">1</span>
                            <span class="hidden item_packing_price">0</span>
                            <span class="hidden item_size">-------</span>
                            <div class="col-lg-5 col-lg-offset-1 col-sm-6 col-sm-offset-1 col-xs-12 ">
                                <div class="title">
                                    <h4 class="item_name"></h4>
                                </div>
                            </div>
                            <div class="col-lg-2 col-lg-offset-3 col-sm-3 col-xs-12 pull-right">
                                <div class="actions">
                                    <div class="cost">
                                        <sup>{{ CURRENCY.symbol }}</sup>
                                        <strong class="item_price"></strong>
                                        <div class="clearfix"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                        </li>
                    </ul>
                    <div class="clearfix"></div>
                </div>
                <div class="col-xs-12 visible-xs" style="margin-top: 15px">
                    <button class="btn btn-deep-blue btn-lg btn-block payment-start pull-right">
                        {% trans "Checkout" %}
                    </button>
                    <div class="clearfix"></div>
                </div>
            </div>
        </div>
    </div>
{#    {% endcache %}#}
    {% with payment_cancel_default='yes' %}
        {% include 'billing/snippets/modal_payment_options.html' %}
    {% endwith %}
{% endblock %}

{% block js %}
    {{ block.super }}
    <script>
        (function() {
            $('.input-group.promo').hide();
            {% if order %}  {#  *** RETURNING TO THIS PAGE AFTER A COMPLETE CHECKOUT ***  #}
                {% if not order.is_more_than_one_hour_old %}
                    simpleCart.empty();
                    {% if order.anonymous_buyer %}
                        localStorage.setItem('anonymousBuyerId', '{{ order.anonymous_buyer.id }}');
                    {% endif %}
                {% endif %}
            {% else %}
                $('<input type="hidden" id="item-ids" name="item_id_list">').appendTo('#payment-start-flow');
                $('body').on('click', '.close', function() {
                    let $cartItem = $(this).parents('.cart-item'),
                        id = $(this).data('id'),
                        item = simpleCart.find({'id': id})[0];
                    item.remove();
                    simpleCart.update();
                    $cartItem.fadeOut('slow', function(c) {
                        $cartItem.remove();
                    });
                    loadCheckoutSummary();
                }).on('click', '.apply-promo-code', function() {
                    let code = $('.promo').find('input[type=text]').val();
                       $.getJSON("{% url 'sales:find_promo_code' %}", {code: code}, function(resp) {
                        if (resp.error) {
                            $(".invalid-code").fadeIn().show();
                            $('.promo').find('input[type=text]').focus()
                        } else {
                            loadCheckoutSummary();
                        }
                    });
                }).on('click', '#coupons .card-li', function() {
                    loadCheckoutSummary();
                }).on('keypress', '.promo input[type=text]',function () {
                    $(".invalid-code").fadeOut().hide()
                }).on('click', '.coupon-img', function() {
                    let id = $(this).data('id');
                    {#$.getJSON('http://localhost/tchopetyamo/rewarding/coupon_detail', {id: id}, function(data) {#}
                    $.getJSON('rewarding/coupon_detail', {id: id}, function(data) {
                        if (data.error) {
                            ikwen.showFloatingNotice(data.error, '', 6);
                            return;
                        }
                        $('div#coupon-detail .modal-title').text(data.name);
                        $('div#coupon-detail img').prop('src', data.image_url);
                        $('div#coupon-detail .description').html(data.description);
                        $('#coupon-detail').modal('show');
                    })
                }).on('click', '.payment-start', function() {
                    simpleCart.load();
                    let itemIDs = [];
                    simpleCart.each(function(item) {
                        itemIDs.push(item.id());
                    });
                    $('#item-ids').val(itemIDs.join(','));
                    $('#payment-methods').modal('show');
                });

                populateCartPanel();

                function populateCartPanel() {
                    simpleCart.load();
                    $('.cart-item:not(.tpl, .packing)').remove();
                    simpleCart.each(function(item) {
                        let url = item.get('url'),
                            size = item.get('size'),
                            $cartItem = $('.cart-item.tpl').clone().removeClass('tpl');
                        $cartItem.attr('id', item.id()).data('id', item.id());
                        $cartItem.find('.item_id').text(item.id());
                        $cartItem.find('.cover-image').css('background-image', 'url(' + item.get('image') + ')');
                        $cartItem.find('.item_url').text(url);
                        $cartItem.find('.cart-item-img').attr('href', url);
                        $cartItem.find('.cart-item-img img').attr('src', item.get('image'));
                        $cartItem.find('.item_name').text(item.get('name'));
                        if (size === '-------') $cartItem.find('.size').hide();
                        else $cartItem.find('.size').show();
                        $cartItem.find('.item_size').text(size);
                        $cartItem.find('.item_size').text(size);
                        $cartItem.find('.item_price').html(item.price().formatMoney({{ CURRENCY.precision }}, '{{ settings.THOUSAND_SEPARATOR }}', '{{ settings.DECIMAL_SEPARATOR }}'));
                        $cartItem.insertBefore('.cart-item.tpl');
                    });
                }
                $('#checkout-summary').on('click', '.promo-code', function () {
                    $(this).remove();
                    $('.input-group.promo').show();
                });

                {# *** START CHECKOUT PROCESS *** #}
                {% url 'shopping:checkout' as checkout_url %}
                {% url 'ikwen:sign_in' as sign_in_url %}
                $('div#suggest-login .register').click(function() {
                    let actionUrl = '{% url 'ikwen:register' %}',
                        deliveryOptionId = $('.delivery-option.active').data('id');
                    $('#next').val('{{ checkout_url }}');
                    $('#delivery-option-id').val(deliveryOptionId);
                    $('form#start-checkout').attr('action', actionUrl).submit();
                    return false;
                });
                $('div#suggest-login .connect').click(function () {
                    let actionUrl = '{{ sign_in_url }}',
                        deliveryOptionId = $('.delivery-option.active').data('id');
                    $('#next').val('{{ checkout_url }}');
                    $('#delivery-option-id').val(deliveryOptionId);
                    $('form#start-checkout').attr('action', actionUrl).submit();
                    return false;
                });
                $('div#suggest-login .turn-down').click(function() {
                    let actionUrl = '{{ checkout_url }}',
                        deliveryOptionId = $('.delivery-option.active').data('id');
                    $('#delivery-option-id').val(deliveryOptionId);
                    $('form#start-checkout').attr('action', actionUrl).submit();
                    return false;
                });
            {% endif %}

            $('.cart-shopping').addClass('hide');
            $('.submit-checkout, .payment-method').click(function() {
                simpleCart.load();
                let itemIDs = [];
                simpleCart.each(function(item) {
                    itemIDs.push(item.id());
                });
                $('#item-ids').val(itemIDs.join(','));
            });
        })()
    </script>
{% endblock %}
